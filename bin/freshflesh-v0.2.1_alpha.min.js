var FF={TextureCache:[],TMXMapCache:[],BitmapFontCache:[],AudioCache:[],Render:{},CanvasRender:function(a){this.canvas=null;this.height=this.width=0}};
FF.CanvasRender.prototype.createRender=function(a){var b,c=this;a?b=a:(b=document.createElement("canvas"),b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.width=FF.Util.screenWidth(),b.height=FF.Util.screenHeight(),document.body.appendChild(b));this.width=b.width;this.height=b.height;window.addEventListener("resize",function(a){a=FF.Util.screenSize();b.width=a.width;c.width=a.width;b.height=a.height;c.height=a.height});this.canvas=b};FF.CanvasRender.prototype.getContext=function(){return this.canvas.getContext("2d")};
FF.CanvasRender.prototype.getWidth=function(){return this.width};FF.CanvasRender.prototype.getHeight=function(){return this.height};FF.CanvasRender.prototype.setBackgroundColor=function(a){if("#FFF"!=a||"#FFFFFF"!=a)this.getContext().save(),this.getContext().fillStyle=a,this.getContext().fillRect(0,0,this.getContext().canvas.width,this.getContext().canvas.height),this.getContext().restore()};FF.CanvasRender.prototype.clearRect=function(a,b,c,d){this.getContext().clearRect(a,b,c,d)};
FF.CanvasRender.prototype.save=function(){this.getContext().save()};FF.CanvasRender.prototype.restore=function(){this.getContext().restore()};FF.CanvasRender.prototype.translate=function(a,b){this.getContext().translate(a,b)};FF.CanvasRender.prototype.rotate=function(a){this.getContext().rotate(a)};FF.CanvasRender.prototype.setAlpha=function(a){this.getContext().globalAlpha=a};FF.CanvasRender.prototype.drawImage=function(a,b,c,d,e){this.getContext().drawImage(a,b,c,d,e)};
FF.CanvasRender.prototype.drawSubImage=function(a,b,c,d,e,k,h,m,n){this.getContext().drawImage(a,b,c,d,e,k,h,m,n)};FF.CanvasRender.prototype.fillRect=function(a,b,c,d,e){this.getContext().save();this.getContext().fillStyle=a;this.getContext().fillRect(b,c,d,e);this.getContext().restore()};FF.CanvasRender.prototype.fillText=function(a,b,c,d,e){this.getContext().save();this.getContext().font=b;this.getContext().fillStyle=c;this.getContext().fillText(a,d,e);this.getContext().restore()};
FF.CanvasRender.prototype.fillTextWithShadow=function(a,b,c,d,e,k,h,m,n){this.getContext().save();this.getContext().font=b;this.getContext().fillStyle=c;this.getContext().shadowColor=k;this.getContext().shadowBlur=n;this.getContext().shadowOffsetX=h;this.getContext().shadowOffsetY=m;this.getContext().fillText(a,d,e);this.getContext().restore()};
FF.CanvasRender.prototype.measureText=function(a,b){this.getContext().save();this.getContext().font=a;var c=this.getContext().measureText(b);this.getContext().restore();return c};FF.CanvasRender.prototype.clip=function(){return this.getContext().clip()};FF.CanvasRender.prototype.beginPath=function(){return this.getContext().beginPath()};FF.CanvasRender.prototype.arc=function(a,b,c,d,e,k){return this.getContext().arc(a,b,c,d,e,k)};
FF.CanvasRender.prototype.rect=function(a,b,c,d){return this.getContext().rect(a,b,c,d)};FF.WebGLRender=function(a){console.log("Using webgl");this.canvas=null;this.height=this.width=0};
FF.WebGLRender.prototype.createRender=function(a){var b,c=this;a?b=a:(b=document.createElement("canvas"),b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.width=FF.Util.screenWidth(),b.height=FF.Util.screenHeight(),document.body.appendChild(b));this.width=b.width;this.height=b.height;window.addEventListener("resize",function(a){a=FF.Util.screenSize();b.width=a.width;c.width=a.width;b.height=a.height;c.height=a.height});this.canvas=b;WebGL2D.enable(this.canvas)};
FF.WebGLRender.prototype.getContext=function(){return this.canvas.getContext("webgl-2d")};FF.WebGLRender.prototype.getWidth=function(){return this.width};FF.WebGLRender.prototype.getHeight=function(){return this.height};FF.WebGLRender.prototype.setBackgroundColor=function(a){this.getContext().save();this.getContext().fillStyle=a;this.getContext().fillRect(0,0,this.getContext().canvas.width,this.getContext().canvas.height);this.getContext().restore()};
FF.WebGLRender.prototype.clearRect=function(a,b,c,d){this.getContext().clearRect(a,b,c,d)};FF.WebGLRender.prototype.save=function(){this.getContext().save()};FF.WebGLRender.prototype.restore=function(){this.getContext().restore()};FF.WebGLRender.prototype.translate=function(a,b){this.getContext().translate(a,b)};FF.WebGLRender.prototype.rotate=function(a){this.getContext().rotate(a)};FF.WebGLRender.prototype.setAlpha=function(a){this.getContext().globalAlpha=a};
FF.WebGLRender.prototype.drawImage=function(a,b,c,d,e){this.getContext().drawImage(a,b,c,d,e)};FF.WebGLRender.prototype.drawSubImage=function(a,b,c,d,e,k,h,m,n){this.getContext().drawImage(a,b,c,d,e,k,h,m,n)};FF.WebGLRender.prototype.fillRect=function(a,b,c,d,e){this.getContext().save();this.getContext().fillStyle=a;this.getContext().fillRect(b,c,d,e);this.getContext().restore()};
FF.WebGLRender.prototype.fillText=function(a,b,c,d,e){this.getContext().save();this.getContext().font=b;this.getContext().fillStyle=c;this.getContext().fillText(a,d,e);this.getContext().restore()};
FF.WebGLRender.prototype.fillTextWithShadow=function(a,b,c,d,e,k,h,m,n){this.getContext().save();this.getContext().font=b;this.getContext().fillStyle=c;this.getContext().shadowColor=k;this.getContext().shadowBlur=n;this.getContext().shadowOffsetX=h;this.getContext().shadowOffsetY=m;this.getContext().fillText(a,d,e);this.getContext().restore()};
FF.WebGLRender.prototype.measureText=function(a,b){this.getContext().save();this.getContext().font=a;var c=this.getContext().measureText(b);this.getContext().restore();return c};FF.WebGLRender.prototype.clip=function(){return this.getContext().clip()};FF.WebGLRender.prototype.beginPath=function(){return this.getContext().beginPath()};FF.WebGLRender.prototype.arc=function(a,b,c,d,e,k){return this.getContext().arc(a,b,c,d,e,k)};
FF.WebGLRender.prototype.rect=function(a,b,c,d){return this.getContext().rect(a,b,c,d)};FF.ImageLoader=function(a){FF.EventManager.call(this);this.imageUrl=a};FF.ImageLoader.prototype.load=function(){var a=this,b=new Image;b.src=this.imageUrl;b.onload=function(b){a.dispatchEvent({type:"loaded"})};FF.TextureCache[this.imageUrl]=b};FF.BitmapFontLoader=function(a){FF.EventManager.call(this);this.url=a};
FF.BitmapFontLoader.prototype.load=function(){var a=this.url.split(".").pop().toLowerCase();if("fnt"!=a)throw Error("[FF.BitmapFontLoader] File type ("+a+") is not supported");this.fromFNT()};
FF.BitmapFontLoader.prototype.fromFNT=function(){var a=this;FF.Util.ajax({type:"POST",url:this.url,complete:function(b){var c=FF.Util.getDOMDocument(b),d=c.getElementsByTagName("page")[0].attributes.getNamedItem("file").nodeValue,e={};b=c.getElementsByTagName("info")[0];var k=c.getElementsByTagName("common")[0];e.font=b.attributes.getNamedItem("face").nodeValue;e.size=parseInt(b.attributes.getNamedItem("size").nodeValue,10);e.lineHeight=parseInt(k.attributes.getNamedItem("lineHeight").nodeValue,10);
e.chars={};e.texture=d;k=c.getElementsByTagName("char");for(b=0;b<k.length;b++){var h=parseInt(k[b].attributes.getNamedItem("id").nodeValue,10),m={x:parseInt(k[b].attributes.getNamedItem("x").nodeValue,10),y:parseInt(k[b].attributes.getNamedItem("y").nodeValue,10),width:parseInt(k[b].attributes.getNamedItem("width").nodeValue,10),height:parseInt(k[b].attributes.getNamedItem("height").nodeValue,10)};e.chars[h]={xOffset:parseInt(k[b].attributes.getNamedItem("xoffset").nodeValue,10),yOffset:parseInt(k[b].attributes.getNamedItem("yoffset").nodeValue,
10),xAdvance:parseInt(k[b].attributes.getNamedItem("xadvance").nodeValue,10),kerning:{},textureRect:m}}c=c.getElementsByTagName("kerning");for(b=0;b<c.length;b++)k=parseInt(c[b].attributes.getNamedItem("first").nodeValue,10),h=parseInt(c[b].attributes.getNamedItem("second").nodeValue,10),m=parseInt(c[b].attributes.getNamedItem("amount").nodeValue,10),e.chars[h].kerning[k]=m;FF.BitmapFontCache[e.font]=e;image=new FF.ImageLoader(d);image.addEventListener("loaded",function(){e.texture=FF.TextureCache[d];
a.onLoaded()});image.load()}})};FF.BitmapFontLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})};FF.AudioLoader=function(a){FF.EventManager.call(this);this.soundUrl=a};FF.AudioLoader.prototype.load=function(){var a=this,b=new Audio(this.soundUrl);b.oncanplaythrough=function(b){a.dispatchEvent({type:"loaded"})};b.load();FF.AudioCache[this.soundUrl]=b};FF.TMXLoader=function(a){FF.EventManager.call(this);this.mapUrl=a};FF.TMXLoader.prototype.load=function(){this.fromTMX()};
FF.TMXLoader.prototype.fromJSON=function(){};
FF.TMXLoader.prototype.fromTMX=function(){var a=this;FF.Util.ajax({type:"POST",url:this.mapUrl,complete:function(b){var c=FF.Util.getDOMDocument(b);b={width:0,height:0,tilewidth:0,tileheight:0,obj_groups:[],layers:[],tilesets:[],orientation:"",properties:{},version:0};b.width=parseInt(c.getElementsByTagName("map")[0].getAttribute("width"));b.height=parseInt(c.getElementsByTagName("map")[0].getAttribute("height"));b.tilewidth=parseInt(c.getElementsByTagName("map")[0].getAttribute("tilewidth"));b.tileheight=
parseInt(c.getElementsByTagName("map")[0].getAttribute("tileheight"));b.version=parseInt(c.getElementsByTagName("map")[0].getAttribute("version"));try{for(var d=c.getElementsByTagName("map")[0].getElementsByTagName("properties")[0].getElementsByTagName("property"),e=0;e<d.length;e++)b.properties[d[e].getAttribute("name")]=d[e].getAttribute("value")}catch(k){}for(var h=c.getElementsByTagName("map")[0].getElementsByTagName("tileset"),m=0;m<h.length;m++){for(var n={firstgid:parseInt(h[m].getAttribute("firstgid")),
positions:[],name:h[m].getAttribute("name"),image:h[m].getElementsByTagName("image")[0].getAttribute("source").split("../").pop(),imagewidth:parseInt(h[m].getElementsByTagName("image")[0].getAttribute("width")),imageheight:parseInt(h[m].getElementsByTagName("image")[0].getAttribute("height")),margin:0,spacing:0,properties:{},tilewidth:parseInt(h[m].getAttribute("tilewidth")),tileheight:parseInt(h[m].getAttribute("tileheight"))},s=1,q=0;q<n.imageheight;q+=n.tileheight)for(var r=0;r<n.imagewidth;r+=
n.tilewidth)n.positions[s]={x:r,y:q},s++;b.tilesets[m]=n}h=c.getElementsByTagName("map")[0].getElementsByTagName("layer");for(m=0;m<h.length;m++){n={name:h[m].getAttribute("name"),x:0,y:0,width:parseInt(h[m].getAttribute("width")),height:parseInt(h[m].getAttribute("height")),opacity:1,type:"tilelayer",visible:!0,properties:{},data:[]};try{for(d=h[m].getElementsByTagName("properties")[0].getElementsByTagName("property"),e=0;e<d.length;e++)n.properties[d[e].getAttribute("name")]=d[e].getAttribute("value")}catch(G){}q=
h[m].getElementsByTagName("tile");for(r=s=0;r<n.width;r++){for(var B=[],A=0;A<n.height;A++)B[A]=q[r+A*n.width].getAttribute("gid"),s++;n.data[r]=B}b.layers[m]=n}c=c.getElementsByTagName("map")[0].getElementsByTagName("objectgroup");for(m=0;m<c.length;m++){s={name:c[m].getAttribute("name"),width:parseInt(c[m].getAttribute("width")),height:parseInt(c[m].getAttribute("height")),objects:[],properties:{}};try{for(d=c[m].getElementsByTagName("properties")[0].getElementsByTagName("property"),e=0;e<d.length;e++)s.properties[d[e].getAttribute("name")]=
d[e].getAttribute("value")}catch(H){}h=c[m].getElementsByTagName("object");for(n=0;n<h.length;n++){q={gid:parseInt(h[n].getAttribute("gid")),x:parseInt(h[n].getAttribute("x")),y:parseInt(h[n].getAttribute("y"))-(h[n].getAttribute("gid")?b.tileheight:0),width:h[n].getAttribute("width")?parseInt(h[n].getAttribute("width")):b.tilewidth,height:h[n].getAttribute("height")?parseInt(h[n].getAttribute("height")):b.tileheight,rect:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},type:h[n].getAttribute("type"),
properties:{}};try{for(d=h[n].getElementsByTagName("properties")[0].getElementsByTagName("property"),e=0;e<d.length;e++)q.properties[d[e].getAttribute("name")]=d[e].getAttribute("value")}catch(I){}s.objects.push(q)}b.obj_groups.push(s)}FF.TMXMapCache[a.mapUrl]=b;a.dispatchEvent({type:"loaded"})}})};
FF.AssetLoader=function(a){FF.EventManager.call(this);this.assetsURL=a;this.loadedCount=0;this.assetsTypes={jpg:FF.ImageLoader,jpeg:FF.ImageLoader,gif:FF.ImageLoader,png:FF.ImageLoader,tmx:FF.TMXLoader,fnt:FF.BitmapFontLoader,json:FF.TMXLoader,mp3:FF.AudioLoader}};
FF.AssetLoader.prototype.load=function(){var a=this;for(i in this.assetsURL){var b=this.assetsURL[i],c=this.assetsURL[i].split(".").pop().toLowerCase(),c=this.assetsTypes[c];if(!c)throw Error("Filetype of ["+b+"] is not supported");c=new c(b);c.addEventListener("loaded",function(){a.loadedAsset(b)});c.load()}};
FF.AssetLoader.prototype.loadedAsset=function(a){this.loadedCount++;this.dispatchEvent({type:"progress",loaded:this.loadedCount,total:this.assetsURL.length,currentFile:a});this.loadedCount==this.assetsURL.length&&this.dispatchEvent({type:"loaded"})};
FF.Sprite=function(a){if(!a.image)throw Error("[FF.Sprite] You have to provide at least the image path for your sprite");if(void 0===FF.TextureCache[a.image])throw Error("[FF.Sprite] You are using a non-loaded asset");FF.EventManager.call(this);this.image=FF.TextureCache[a.image];this.originalWidth=this.image.width;this.originalHeight=this.image.height;this.x=a.x||0;this.y=a.y||0;this.scale=(a.fitRenderHeight?Math.ceil(FF.Render.getHeight()/this.originalHeight):a.scale)||1;this.rotate=a.rotate||0;
this.roundClip=a.roundClip||!1;this.rectClip=a.rectClip||!1;this.anchor=a.anchor||[0,0];this.alpha=a.alpha||1;this.hidden=a.hidden||!1;this.hover=!1};FF.Sprite.prototype.rect=function(){return{x:this.x,y:this.y,width:this.originalWidth*this.scale,height:this.originalHeight*this.scale}};FF.Sprite.prototype.center=function(){return{x:this.x+this.originalWidth*this.scale/2,y:this.y+this.originalHeight*this.scale/2}};
FF.Sprite.prototype.update=function(){FF.InputManager.mouse_x>=this.x&&FF.InputManager.mouse_x<=this.x+this.rect().width&&FF.InputManager.mouse_y>=this.y&&FF.InputManager.mouse_y<=this.y+this.rect().height?(FF.InputManager.pressedWithoutRepeat(["left_mouse_button"])&&this.dispatchEvent({type:"click"}),this.hover=!0,!1==this.hidden&&this.dispatchEvent({type:"mouseover"})):(!0==this.hover&&!1==this.hidden&&this.dispatchEvent({type:"mouseout"}),this.hover=!1)};
FF.Sprite.prototype.draw=function(){this.hidden||(FF.Render.save(),FF.Render.setAlpha(this.alpha),!1!=this.roundClip&&(FF.Render.beginPath(),FF.Render.arc(this.roundClip.x+this.roundClip.width/2,this.roundClip.y+this.roundClip.height/2,this.roundClip.width/2,0,2*Math.PI,!1),FF.Render.clip()),!1!=this.rectClip&&(FF.Render.beginPath(),FF.Render.rect(this.rectClip.x,this.rectClip.y,this.rectClip.width,this.rectClip.height),FF.Render.clip()),FF.Render.translate(this.rect().x+this.anchor[0],this.rect().y+
this.anchor[1]),this.lastRotate&&this.lastRotate!=this.rotate&&this.dispatchEvent({type:"rotate",angle:this.rotate-this.lastRotate}),FF.Render.rotate(this.rotate*Math.PI/180),FF.Render.translate(-(this.rect().x+this.anchor[0]),-(this.rect().y+this.anchor[1])),this.lastRotate=this.rotate,FF.Render.drawImage(this.image,this.x,this.y,this.originalWidth*this.scale,this.originalHeight*this.scale),FF.Render.restore())};
FF.Sprite.prototype.switchImage=function(a){if(!a)throw Error("[FF.Sprite] You have to provide the image path of your sprite");if(void 0===FF.TextureCache[a])throw Error("[FF.Sprite] You are using a non-loaded asset");this.image=FF.TextureCache[a]};
FF.SpriteSheet=function(a){if(!a.image)throw Error("[FF.SpriteSheet] You have to provide at least the image path for your sprite");if(void 0===FF.TextureCache[a.image])throw Error("[FF.SpriteSheet] You are using a non-loaded asset");FF.EventManager.call(this);this.image=FF.TextureCache[a.image];this.originalWidth=this.image.width;this.frameWidth=a.frame_size[0]||this.image.width;this.originalHeight=this.image.height;this.frameHeight=a.frame_size[1]||this.image.height;this.x=a.x||0;this.y=a.y||0;this.scale=
a.scale||1;this.alpha=a.alpha||1;this.hidden=a.hidden||!1;this.bounds=a.bounds||[0,0,this.frameWidth,this.frameHeight];this.hover=!1;this.currentGID=0;this.frames=[];this.positions=[];for(var b=a=0;b<this.originalHeight;b+=this.frameHeight)for(var c=0;c<this.originalWidth;c+=this.frameWidth)this.frames.push(a),this.positions[a]={x:c,y:b},a++};FF.SpriteSheet.prototype.rect=function(){return{x:this.x,y:this.y,width:this.bounds[2]*this.scale,height:this.bounds[3]*this.scale}};
FF.SpriteSheet.prototype.update=function(){FF.InputManager.mouse_x>=this.x&&FF.InputManager.mouse_x<=this.x+this.rect().width&&FF.InputManager.mouse_y>=this.y&&FF.InputManager.mouse_y<=this.y+this.rect().height?(FF.InputManager.pressedWithoutRepeat(["left_mouse_button"])&&this.dispatchEvent({type:"click"}),this.hover=!0,!1==this.hidden&&this.dispatchEvent({type:"mouseover"})):(!0==this.hover&&!1==this.hidden&&this.dispatchEvent({type:"mouseout"}),this.hover=!1)};
FF.SpriteSheet.prototype.draw=function(){if(!this.hidden){var a=this.positions[this.currentGID];FF.Render.save();FF.Render.setAlpha(this.alpha);FF.Render.drawSubImage(this.image,a.x,a.y,this.frameWidth*this.scale,this.frameHeight*this.scale,this.x-this.bounds[0],this.y-this.bounds[1],this.frameWidth*this.scale,this.frameHeight*this.scale);FF.Render.restore()}};
FF.SpriteSheet.prototype.switchImage=function(a){if(!a)throw Error("[FF.SpriteSheet] You have to provide the image path of your sprite");if(void 0===FF.TextureCache[a])throw Error("[FF.SpriteSheet] You are using a non-loaded asset");this.image=FF.TextureCache[a]};FF.SpriteSheet.prototype.setFrame=function(a){this.currentGID=a};
FF.Parallax=function(a){FF.EventManager.call(this);this.width=a.width||FF.Render.getWidth();this.height=a.height||FF.Render.getHeight();this.x=a.x||0;this.y=a.y||0;this.repeat_x=a.repeat_x||!0;this.repeat_y=a.repeat_y||!1;this.camera_x=a.camera_x||0;this.camera_y=a.camera_y||0;this.layers=a.layers||[]};FF.Parallax.addLayer=function(a){this.layers.push(a)};
FF.Parallax.prototype.draw=function(){for(var a=0;a<this.layers.length;a++){var b,c;b=this.layers[a];c=this.repeat_x?-(this.camera_x/b.speed%b.sprite.rect().width):-(this.camera_x/b.speed);b.sprite.y=this.repeat_y?-(this.camera_y/b.speed%b.sprite.rect().height):-(this.camera_y/b.speed);b.sprite.x=c;0<b.sprite.rect().x&&(b.sprite.x=0);for(;b.sprite.y<this.height;){for(;b.sprite.rect().x<this.width&&(0<=b.sprite.rect().x+b.sprite.rect().width&&0<=b.sprite.rect().y+b.sprite.rect().height&&b.sprite.draw(),
b.sprite.x=b.sprite.rect().x+b.sprite.rect().width,this.repeat_x););b.sprite.y=b.sprite.rect().y+b.sprite.rect().height;b.sprite.x=c;if(!this.repeat_y)break}}};FF.TiledMap=function(a){if(!a.map)throw Error("[FF.TiledMap] You have to provide at least the path for your tiledmap");if(void 0===FF.TMXMapCache[a.map])throw Error("[FF.TiledMap] You are using a non-loaded asset ("+a.map+")");this.map=FF.TMXMapCache[a.map];this.x=a.x||0;this.y=a.y||0;this.alpha=a.alpha||1};
FF.TiledMap.prototype.getTilesetNumber=function(a){for(var b=a=0;b<this.map.tilesets.length;b++)this.map.tilesets[b+1]&&(a=b);return a};
FF.TiledMap.prototype.drawImageFromGID=function(a,b,c,d){if(!isNaN(c)){var e=this.getTilesetNumber(c),e=this.map.tilesets[e];c=e.positions[c];if(void 0===FF.TextureCache[e.image])throw Error("[FF.TiledMap.drawImageFromGID] You are using a non-loaded asset");FF.Render.drawSubImage(FF.TextureCache[e.image],c.x,c.y,e.tilewidth,e.tileheight,"object"==d?a:this.x+a*e.tilewidth,"object"==d?b:this.y+b*e.tileheight,e.tilewidth,e.tileheight)}};
FF.TiledMap.prototype.drawRect=function(a){FF.Render.fillRect("rgba(255,0,0,0.5)",a.rect().x,a.rect().y,a.rect().width,a.rect().height)};
FF.TiledMap.prototype.draw=function(){FF.Render.save();FF.Render.setAlpha(this.alpha);for(var a=0;a<this.map.layers.length;a++){var b=this.map.layers[a].data;if(!b.properties||!b.properties.drawable||"false"!=b.properties.drawable)for(var c=0;c<b.length;c++)for(var d=0;d<b[c].length;d++)0!=b[c][d]&&this.drawImageFromGID(c,d,b[c][d],"tile")}for(a=0;a<this.map.obj_groups.length;a++)if(b=this.map.obj_groups[a],!b.properties||!b.properties.drawable||"false"!=b.properties.drawable)for(c=0;c<b.objects.length;c++)d=
b.objects[c],isNaN(d.gid)||this.drawImageFromGID(d.x,d.y,d.gid,"object");FF.Render.restore()};FF.TiledMap.prototype.drawLayer=function(a){FF.Render.save();FF.Render.setAlpha(this.alpha);for(var b=0;b<this.map.layers.length;b++){var c=this.map.layers[b].data;if(this.map.layers[b].name==a)for(var d=0;d<c.length;d++)for(var e=0;e<c[d].length;e++)0!=c[d][e]&&this.drawImageFromGID(d,e,c[d][e],"tile")}FF.Render.restore()};
FF.TiledMap.prototype.drawEveryLayerBut=function(a){FF.Render.save();FF.Render.setAlpha(this.alpha);for(var b=0;b<this.map.layers.length;b++){var c=this.map.layers[b].data;if(c.name!=a)for(var d=0;d<c.length;d++)for(var e=0;e<c[d].length;e++)0!=c[d][e]&&this.drawImageFromGID(d,e,c[d][e],"tile")}FF.Render.restore()};
FF.TiledMap.prototype.drawObjectGroup=function(a){FF.Render.save();FF.Render.setAlpha(this.alpha);for(var b=0;b<this.map.obj_groups.length;b++){var c=this.map.obj_groups[b];if(c.name==a)for(var d=0;d<c.objects.length;d++){var e=c.objects[d];this.drawImageFromGID(e.x,e.y,e.gid,"object")}}FF.Render.restore()};
FF.TiledMap.prototype.drawEveryObjectGroups=function(){FF.Render.save();FF.Render.setAlpha(this.alpha);for(var a=0;a<this.map.obj_groups.length;a++)for(var b=this.map.obj_groups[a],c=0;c<b.objects.length;c++){var d=b.objects[c];this.drawImageFromGID(d.x,d.y,d.gid,"object")}FF.Render.restore()};FF.TiledMap.prototype.rect=function(){return{x:this.x,y:this.y,width:this.map.width*this.map.tilewidth,height:this.map.height*this.map.tileheight}};
FF.TiledMap.prototype.getRectFromTile=function(a,b,c){var d=this;c=this.getTilesetNumber(c);var e=this.map.tilesets[c];return{rect:function(){return{x:d.x+a*e.tilewidth,y:d.y+b*e.tileheight,width:e.tilewidth,height:e.tileheight}}}};FF.TiledMap.prototype.foreach=function(a){l=1;var b=this.map.layers[l].data,c;for(c in b)for(var d in b[c])0!=b[c][d]&&a(this.getRectFromTile(c,d,b[c][d]))};
FF.TiledMap.prototype.atRect=function(a){var b=[],c=parseInt(a.x/this.map.tilewidth);0>c&&(c=0);var d=parseInt((a.x+a.width)/this.map.tilewidth);d>=this.map.width&&(d=this.map.width-1);var e=parseInt(a.y/this.map.tileheight);0>e&&(e=0);a=parseInt((a.y+a.height)/this.map.tileheight);for(a>=this.map.height&&(a=this.map.height-1);c<=d;c++)for(var k=e;k<=a;k++)for(var h=0;h<this.map.layers.length;h++)if(this.map.layers[h].properties.blocant&&"true"==this.map.layers[h].properties.blocant){var m=this.map.layers[h].data[c][k];
0!=m&&-1==b.indexOf(this.getRectFromTile(c,k,m))&&b.push(this.getRectFromTile(c,k,m))}return b};FF.TiledMap.prototype.itemCollideWithSomethingInMap=function(a,b){if(b.obj_group){var c=this.getObjectGroup(b.obj_group),c=c&&c.objects?c.objects:[];return FF.Util.collideOneWithMany(a,c)}if(b.layer)return c=this.getLayer(b.layer),FF.Util.collideOneWithMany(a,c)};
FF.TiledMap.prototype.removeObject=function(a,b){if(b){var c=this.getObjectGroup(b),d=c.objects.indexOf(a);-1!=d&&c.objects.splice(d,1)}else for(var e=0;e<this.map.obj_groups.length;e++)if(c=this.map.obj_groups[e],d=c.objects.indexOf(a),-1!=d){c.objects.splice(d,1);break}};FF.TiledMap.prototype.getObjectGroup=function(a){for(var b=0;b<this.map.obj_groups.length;b++)if(this.map.obj_groups[b].name==a)return this.map.obj_groups[b]};
FF.TiledMap.prototype.getObjectFromPropertyValue=function(a,b,c,d){for(var e=0;e<a.length;e++)if(a[e].type==b&&a[e].properties[c]&&a[e].properties[c]==d)return a[e]};FF.TiledMap.prototype.getLayer=function(a){for(var b=0;b<this.map.layers.length;b++)if(this.map.layers[b].name==a)return this.map.layers[b]};
FF.BitmapText=function(a){if(void 0===a.text||!a.fontFamily)throw Error("[FF.BitmapText] You have to provide at least text & fontFamily for your bitmaptext");if(!FF.BitmapFontCache[a.fontFamily])throw Error("[FF.BitmapText] You are using a non-loaded asset");FF.EventManager.call(this);this.x=a.x||0;this.y=a.y||0;this.alpha=a.alpha||1;this.rotate=a.rotate||0;this.anchor=a.anchor||[0,0];this.text=""+a.text;this.align=a.align||"left";this.hidden=a.hidden||!1;this.fontName=a.fontFamily;this.data=FF.BitmapFontCache[this.fontName];
this.fontSize=a.fontSize||FF.BitmapFontCache[this.fontName].size;this.chars={};this.lineWidths=[];this.maxLineWidth=0;this.lineAlignOffsets=[];this.setup()};FF.BitmapText.prototype.rect=function(){return{x:this.x,y:this.y,width:this.maxLineWidth,height:this.lineWidths.length*this.data.lineHeight}};
FF.BitmapText.prototype.setup=function(){this.chars={};this.lineWidths=[];this.maxLineWidth=0;this.lineAlighOffsets=[];var a=0,b=0,c=null,d=0,e=this.fontSize/this.data.size;this.chars[d]=[];for(var k=0;k<this.text.length;k++){var h=this.text.charCodeAt(k);if(/(?:\r\n|\r|\n)/.test(this.text.charAt(k)))this.chars[d]=[],this.lineWidths.push(a),this.maxLineWidth=Math.max(this.maxLineWidth,a),d++,a=0,b+=data.lineHeight*e,c=null;else{var m=this.data.chars[h];m&&(c&&m[c]&&(a+=m.kerning[c]*e),this.chars[d].push({textureRect:m.textureRect,
charCode:h,position:{x:a+m.xOffset*e,y:b+m.yOffset*e}}),a+=m.xAdvance*e,c=h)}}this.lineWidths.push(a);this.maxLineWidth=Math.max(this.maxLineWidth,a);for(k=0;k<=d;k++)a=0,"right"==this.align?a=this.maxLineWidth-this.lineWidths[k]:"center"==this.align&&(a=(this.maxLineWidth-this.lineWidths[k])/2),this.lineAlignOffsets.push(a)};
FF.BitmapText.prototype.draw=function(){if(!this.hidden){var a=this.fontSize/this.data.size;FF.Render.save();FF.Render.setAlpha(this.alpha);FF.Render.translate(this.rect().x+this.anchor[0],this.rect().y+this.anchor[1]);this.lastRotate&&this.lastRotate!=this.rotate&&this.dispatchEvent({type:"rotate",angle:this.rotate-this.lastRotate});FF.Render.rotate(this.rotate*Math.PI/180);FF.Render.translate(-(this.rect().x+this.anchor[0]),-(this.rect().y+this.anchor[1]));this.lastRotate=this.rotate;for(var b in this.chars)for(var c=
0;c<this.chars[b].length;c++){var d=this.chars[b][c];FF.Render.drawSubImage(this.data.texture,d.textureRect.x,d.textureRect.y,d.textureRect.width,d.textureRect.height,this.x+d.position.x,this.y+d.position.y,d.textureRect.width*a,d.textureRect.height*a)}FF.Render.restore()}};FF.BitmapText.prototype.setText=function(a){this.text=""+a;this.setup()};
FF.Music=function(a){if(!a.music)throw Error("[FF.Music] You have to provide at least the file path for your music");FF.EventManager.call(this);this.player=FF.AudioCache[a.music]||new Audio(a.music);this.player.load();this.player.loop=a.loop||!1;this.player.autoplay=a.autoplay||!1;this.player.volume=a.volume/100||1};FF.Music.prototype.play=function(){this.player.play()};FF.Music.prototype.pause=function(){this.player.pause()};
FF.Music.prototype.moveTo=function(a){a>this.player.duration||(this.player.currentTime=a)};FF.Music.prototype.forward=function(a){this.player.currentTime+a>duration||(this.player.currentTime+=a)};FF.Music.prototype.backward=function(a){this.player.currentTime-a<duration||(this.player.currentTime-=a)};
FF.Sound=function(a){if(!a.sound)throw Error("[FF.Sound] You have to provide at least the file path for your sound");if(void 0===FF.AudioCache[a.sound])throw Error("[FF.Sound] You are using a non-loaded asset");FF.EventManager.call(this);this.player=FF.AudioCache[a.sound];this.player.loop=a.loop||!1;this.player.autoplay=a.autoplay||!1;this.player.volume=a.volume/100||1};
FF.Sound.prototype.play=function(){var a=this.player.cloneNode();a.ontimeupdate=function(){this.currentTime>=this.duration&&delete a};a.play()};FF.Sound.prototype.pause=function(){this.player.pause()};FF.Sound.prototype.moveTo=function(a){a>this.player.duration||(this.player.currentTime=a)};FF.Sound.prototype.forward=function(a){this.player.currentTime+a>duration||(this.player.currentTime+=a)};FF.Sound.prototype.backward=function(a){this.player.currentTime-a<duration||(this.player.currentTime-=a)};
FF.Animation=function(a,b,c){FF.EventManager.call(this);var d=this;this.node=a;this.timer=new FF.Timer({timeout:b,interval:c.step||2,autostart:c.autostart});this.timer.addEventListener("start",function(){d.dispatchEvent({type:"start"})});this.timer.addEventListener("tick",function(a){d.animate(a);d.dispatchEvent({type:"step"})});this.timer.addEventListener("timeout",function(){d.dispatchEvent({type:"end"})});this.animateLeft=c.left||null;this.animateRight=c.right||null;this.animateTop=c.top||null;
this.animateBottom=c.bottom||null;this.animateWidth=c.width||null;this.animateHeight=c.height||null;this.animateScale=c.scale||null;this.animateOpacity=c.opacity||null};FF.Animation.prototype.update=function(){this.timer.update()};
FF.Animation.prototype.animate=function(a){a=a.remaining/this.timer.timeout*100;this.animateLeft&&(this.node.x-=this.animateLeft*a);this.animateRight&&(this.node.x+=this.animateRight*a);this.animateTop&&(this.node.y-=this.animateTop*a);this.animateBottom&&(this.node.y+=this.animateBottom*a);this.animateWidth&&(this.node.width+=this.animateWidth*a);this.animateHeight&&(this.node.height+=this.animateHeight*a);this.animateScale&&0<this.node.scale&&(this.node.scale+=this.animateScale*a);this.animateOpacity&&
0<this.node.opacity&&(this.node.opacity+=this.animateOpacity*a)};FF.Animation.prototype.start=function(){this.timer.restart()};FF.EventManager=function(){var a=[];this.addEventListener=function(b,c){void 0===a[b]&&(a[b]=[]);-1===a[b].indexOf(c)&&a[b].push(c)};this.dispatchEvent=function(b){for(var c in a[b.type])a[b.type][c](b)};this.removeEventListener=function(b,c){var d=a[b].indexOf(c);-1!==d&&a[b].splice(d,1)}};
FF.Game=function(a,b){function c(){if(void 0===d.currentGameState.update)throw Error("[FF.Game.requestAnimationFrame] Your GameState have to contain an update() function (even if you let it empty)");if(void 0===d.currentGameState.draw)throw Error("[FF.Game.requestAnimationFrame] Your GameState have to contain an draw() function (even if you let it empty)");d.currentGameState.isStarted&&(d.currentGameState.update(),FF.Render.clearRect(0,0,FF.Render.getWidth(),FF.Render.getHeight()),FF.Render.setBackgroundColor(d.backgroundColor),
d.currentGameState.draw());if(null==d.lastCalledTime)d.lastCalledTime=(new Date).getTime(),d.fps=0;else{var a=((new Date).getTime()-d.lastCalledTime)/1E3;d.lastCalledTime=(new Date).getTime();d.fps=(1/a).toFixed(1)}requestAnimationFrame(c)}var d=this;this.previousGameState=null;this.currentGameState=a;this.backgroundColor=b.backgroundColor||"#FFF";this.lastCalledTime=null;this.fps=0;this.launch=function(){if(!0==this.currentGameState.isStarted)throw Error("[FF.Game.Start] Your GameState is already started");
if(void 0===this.currentGameState.setup)throw Error("[FF.Game.Start] Your GameState have to contain a setup() function");void 0===FF.Render.canvas&&(FF.Render=FF.Util.createRender(b.view));!1==FF.InputManager.isSetup&&FF.InputManager.setup();this.currentGameState.setup();if(void 0===this.currentGameState.isStarted||!1==this.currentGameState.isStarted)this.currentGameState.isStarted=!0;c()}};
FF.Game.prototype.switchGameState=function(a,b){if(void 0===a)throw Error("[FF.Game.switchGameState] Your gamestate is undefined (not instanciated, like gs = new Blablabla();)");this.previousGameState=this.currentGameState;this.currentGameState=b?new a.constructor:a;if(void 0===this.currentGameState.setup)throw Error("[FF.Game.switchGameState] Your GameState have to contain a setup() function");!1==this.currentGameState.isStarted&&(FF.InputManager.resetPressedKeys(),this.currentGameState.setup(),
this.currentGameState.isStarted=!0)};
FF.GameState=function(a){this.children=[];this.isStarted=!1;this.setup=function(){for(var b in this.children)this.children[b].setup();a.setup&&a.setup()};this.update=function(){for(var b in this.children)this.children[b].update();a.update&&a.update()};this.draw=function(){for(var b in this.children)this.children[b].draw();a.draw&&a.draw()};this.add=function(a){if(!a.setup||!a.update||!a.draw)throw Error("[FF.GameState.add] Your item have to contain .setup(), .update() & .draw() functions");this.children.push(a)}};
FF.InputManager={};FF.InputManager.isSetup=!1;FF.InputManager.mouse_x=0;FF.InputManager.mouse_y=0;FF.InputManager.pressed_keys=[];FF.InputManager.previously_pressed_keys=[];FF.InputManager.keycode_to_string=[];FF.InputManager.on_keydown_callbacks=[];FF.InputManager.on_keyup_callbacks=[];FF.InputManager.mousebuttoncode_to_string=[];FF.InputManager.ie_mousebuttoncode_to_string=[];FF.InputManager.prevent_default_keys=[];
FF.InputManager.setup=function(){var a=[];a[8]="backspace";a[9]="tab";a[13]="enter";a[16]="shift";a[17]="ctrl";a[18]="alt";a[19]="pause";a[20]="capslock";a[27]="esc";a[32]="space";a[33]="pageup";a[34]="pagedown";a[35]="end";a[36]="home";a[37]="left";a[38]="up";a[39]="right";a[40]="down";a[45]="insert";a[46]="delete";a[91]="left_window_key leftwindowkey";a[92]="right_window_key rightwindowkey";a[93]="select_key selectkey";a[106]="multiply *";a[107]="add plus +";a[109]="subtract minus -";a[110]="decimalpoint";
a[111]="divide /";a[144]="numlock";a[145]="scrollock";a[186]="semicolon ;";a[187]="equalsign =";a[188]="comma ,";a[189]="dash -";a[190]="period .";a[191]="forwardslash /";a[192]="graveaccent `";a[219]="openbracket [";a[220]="backslash \\";a[221]="closebracket ]";a[222]="singlequote '";FF.InputManager.mousebuttoncode_to_string=["left_mouse_button","center_mouse_button","right_mouse_button"];FF.InputManager.ie_mousebuttoncode_to_string=[,"left_mouse_button","right_mouse_button",,"center_mouse_button"];
for(var b="numpad0 numpad1 numpad2 numpad3 numpad4 numpad5 numpad6 numpad7 numpad8 numpad9".split(" "),c="f1 f2 f3 f4 f5 f6 f7 f8 f9".split(" "),d="0123456789".split(""),e="abcdefghijklmnopqrstuvwxyz".split(""),k=0;d[k];k++)a[48+k]=d[k];for(k=0;e[k];k++)a[65+k]=e[k];for(k=0;b[k];k++)a[96+k]=b[k];for(k=0;c[k];k++)a[112+k]=c[k];FF.InputManager.keycode_to_string=a;window.addEventListener("keydown",FF.InputManager.handleKeyDown);window.addEventListener("keyup",FF.InputManager.handleKeyUp);window.addEventListener("mousedown",
FF.InputManager.handleMouseDown,!1);window.addEventListener("mouseup",FF.InputManager.handleMouseUp,!1);window.addEventListener("mousemove",FF.InputManager.handleMouseMove,!1);window.addEventListener("touchstart",FF.InputManager.handleTouchStart,!1);window.addEventListener("touchend",FF.InputManager.handleTouchEnd,!1);window.addEventListener("blur",FF.InputManager.resetPressedKeys,!1);document.oncontextmenu=function(){return!1};FF.InputManager.isSetup=!0};
FF.InputManager.resetPressedKeys=function(a){FF.InputManager.pressed_keys={}};FF.InputManager.handleKeyUp=function(a){a=a||window.event;var b=FF.InputManager.keycode_to_string[a.keyCode].split(" ");for(i in b){var c=b[i];FF.InputManager.pressed_keys[c]=!1;FF.InputManager.on_keyup_callbacks[c]&&(FF.InputManager.on_keyup_callbacks[c](c),a.preventDefault());FF.InputManager.prevent_default_keys[c]&&a.preventDefault()}};
FF.InputManager.handleKeyDown=function(a){a=a||window.event;var b=FF.InputManager.keycode_to_string[a.keyCode].split(" ");for(i in b){var c=b[i];FF.InputManager.pressed_keys[c]=!0;FF.InputManager.on_keydown_callbacks[c]&&(FF.InputManager.on_keydown_callbacks[c](c),a.preventDefault());FF.InputManager.prevent_default_keys[c]&&a.preventDefault()}};
FF.InputManager.handleMouseDown=function(a){a=a||window.event;var b=FF.InputManager.mousebuttoncode_to_string[a.button];"Microsoft Internet Explorer"==navigator.appName&&(b=FF.InputManager.ie_mousebuttoncode_to_string[a.button]);FF.InputManager.pressed_keys[b]=!0;FF.InputManager.on_keydown_callbacks[b]&&(FF.InputManager.on_keydown_callbacks[b](b),a.preventDefault())};
FF.InputManager.handleMouseUp=function(a){a=a||window.event;var b=FF.InputManager.mousebuttoncode_to_string[a.button];"Microsoft Internet Explorer"==navigator.appName&&(b=FF.InputManager.ie_mousebuttoncode_to_string[a.button]);FF.InputManager.pressed_keys[b]=!1;FF.InputManager.on_keyup_callbacks[b]&&(FF.InputManager.on_keyup_callbacks[b](b),a.preventDefault())};
FF.InputManager.handleMouseMove=function(a){a=a||window.event;a.pageX||a.pageY?(FF.InputManager.mouse_x=a.pageX,FF.InputManager.mouse_y=a.pageY):(FF.InputManager.mouse_x=a.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft,FF.InputManager.mouse_y=a.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop)};
FF.InputManager.handleTouchStart=function(a){a=a||window.event;FF.InputManager.pressed_keys.left_mouse_button=!0;FF.InputManager.mouse_x=a.touches[0].pageX-FF.Render.View.offsetLeft;FF.InputManager.mouse_y=a.touches[0].pageY-FF.Render.View.offsetTop};FF.InputManager.handleTouchEnd=function(a){FF.InputManager.pressed_keys.left_mouse_button=!1;FF.InputManager.mouse_x=void 0;FF.InputManager.mouse_y=void 0};
FF.InputManager.preventDefaultKeys=function(a){FF.Util.isString(a)||(a=a.split(" "));for(var b in a)FF.InputManager.prevent_default_keys[a[b]]=!0};FF.InputManager.pressed=function(a,b){FF.Util.isString(a)&&(a=a.split(" "));return b?a.every(function(a){return FF.InputManager.pressed_keys[a]}):a.some(function(a){return FF.InputManager.pressed_keys[a]})};
FF.InputManager.pressedWithoutRepeat=function(a,b){if(FF.InputManager.pressed(a,b)){if(!FF.InputManager.previously_pressed_keys[a])return FF.InputManager.previously_pressed_keys[a]=!0}else return FF.InputManager.previously_pressed_keys[a]=!1};FF.InputManager.on_keydown=function(a,b){if(FF.Util.isArray(a))for(var c=0;a[c];c++)FF.InputManager.on_keydown_callbacks[a[c]]=b;else FF.InputManager.on_keydown_callbacks[a]=b};
FF.InputManager.on_keyup=function(a,b){if(FF.Util.isArray(a))for(var c=0;a[c];c++)FF.InputManager.on_keyup_callbacks[a[c]]=b;else FF.InputManager.on_keyup_callbacks[a]=b};FF.InputManager.clearKeyCallbacks=function(){FF.InputManager.on_keyup_callbacks=[];FF.InputManager.on_keydown_callbacks=[]};FF.Shooter=function(){};FF.Shooter.affine=function(a,b){return{A:(b.y-a.y)/(b.x-a.x),B:(b.x*a.y-a.x*b.y)/(b.x-a.x),origin:a,dest:b}};
FF.Shooter.shootAt=function(a,b){var c={x:3*(b.x-a.x),y:3*(b.y-a.y)};10>FF.Shooter.distanceBetween(a,b)&&(c.x*=30,c.y*=30);return{speed:c,origin:a,dest:b}};FF.Shooter.realMoveSpeed=function(a){return"Infinity"==GAME.fps||"Infinity"==60/GAME.fps*a/1.2?a:60/GAME.fps*a/1.2};FF.Shooter.mouseInViewport=function(a){return{x:FF.InputManager.mouse_x+a.rect().x,y:FF.InputManager.mouse_y+a.rect().y}};FF.Shooter.turnAroundMouse=function(a,b){return FF.Shooter.toDegrees(Math.atan2(b.x-a.x,a.y-b.y))};
FF.Shooter.toDegrees=function(a){return 360*(0<a?a:2*Math.PI+a)/(2*Math.PI)};FF.Shooter.distanceBetween=function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))};FF.Timer=function(a){FF.EventManager.call(this);this.time=0;this.timeout=a.timeout||1E4;this.interval=a.interval||1E3;this.lastTick=new Date;this.autostart=a.autostart||!1;this.active=a.autostart||!1;this.autostart&&this.dispatchEvent({type:"start"})};
FF.Timer.prototype.update=function(){this.active&&(this.time>=this.timeout&&(this.dispatchEvent({type:"timeout"}),this.reset()),new Date-this.lastTick>=this.interval&&(this.time+=this.interval,this.dispatchEvent({type:"tick",remaining:this.timeout-this.time}),this.lastTick=new Date))};FF.Timer.prototype.reset=function(){this.time=0;this.lastTick=new Date;this.dispatchEvent({type:"timeout"});this.autostart?this.restart():this.active=!1};
FF.Timer.prototype.restart=function(){this.time=0;this.lastTick=new Date;this.dispatchEvent({type:"start"});this.active=!0};FF.Timer.prototype.getRemainingTime=function(){return this.timeout-this.time};for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];
window.requestAnimationFrame||(window.requestAnimationFrame=function(a,b){var c=(new Date).getTime(),d=Math.max(0,16-(c-lastTime)),e=window.setTimeout(function(){a(c+d)},d);lastTime=c+d;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});
(function(a,b){function c(a){return 0<a&&0===(a-1&a)}function d(a){return this.clearStack(a)}var e={identity:[1,0,0,0,1,0,0,0,1],multiply:function(a,b){var c=a[0],d=a[1],e=a[2],k=a[3],m=a[4],f=a[5],h=a[6],n=a[7],s=a[8],q=b[0],r=b[1],z=b[2],t=b[3],g=b[4],u=b[5],w=b[6],p=b[7],y=b[8];b[0]=q*c+t*d+w*e;b[1]=r*c+g*d+p*e;b[2]=z*c+u*d+y*e;b[3]=q*k+t*m+w*f;b[4]=r*k+g*m+p*f;b[5]=z*k+u*m+y*f;b[6]=q*h+t*n+w*s;b[7]=r*h+g*n+p*s;b[8]=z*h+u*n+y*s},vec2_multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[3]*a[1]+b[6];
c[1]=b[1]*a[0]+b[4]*a[1]+b[7];return c},transpose:function(a){return[a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]}};d.prototype.clearStack=function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;for(var c=0;16>c;c++)this.m_stack[c]=this.getIdentity();a!==b?this.m_stack[0]=a:this.setIdentity()};d.prototype.setIdentity=function(){this.m_stack[this.c_stack]=this.getIdentity();this.valid===this.c_stack&&this.c_stack&&this.valid--};d.prototype.getIdentity=function(){return[1,
0,0,0,1,0,0,0,1]};d.prototype.getResult=function(){if(!this.c_stack)return this.m_stack[0];var a=e.identity;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var b=this.valid;b<this.c_stack+1;b++)a=e.multiply(this.m_stack[b],a),this.m_cache[b]=a;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]};d.prototype.pushMatrix=function(){this.c_stack++;this.m_stack[this.c_stack]=this.getIdentity()};d.prototype.popMatrix=function(){0!==this.c_stack&&this.c_stack--};var k=d.prototype.getIdentity();
d.prototype.translate=function(a,b){k[6]=a;k[7]=b;e.multiply(k,this.m_stack[this.c_stack])};var h=d.prototype.getIdentity();d.prototype.scale=function(a,b){h[0]=a;h[4]=b;e.multiply(h,this.m_stack[this.c_stack])};var m=d.prototype.getIdentity();d.prototype.rotate=function(b){var c;c=a.sin(-b);b=a.cos(-b);m[0]=b;m[3]=c;m[1]=-c;m[4]=b;e.multiply(m,this.m_stack[this.c_stack])};var n=this.WebGL2D=function(a,c){this.canvas=a;this.options=c||{};this.shaderProgram=this.vs=this.fs=this.gl=b;this.transform=
new d;this.shaderPool=[];this.maxTextureSize=b;a.gl2d=this;a.$getContext=a.getContext;a.getContext=function(b){return function(c){if(!b.options.force&&"webgl-2d"!==c||0===a.width||0===a.height)return b.canvas.$getContext(c);if(b.gl)return b.gl;c=b.gl=b.canvas.$getContext("experimental-webgl");b.initShaders();b.initBuffers();b.initCanvas2DAPI();c.viewport(0,0,b.canvas.width,b.canvas.height);c.clearColor(1,1,1,1);c.clear(c.COLOR_BUFFER_BIT);c.colorMask(1,1,1,0);c.enable(c.BLEND);c.blendFunc(c.SRC_ALPHA,
c.ONE_MINUS_SRC_ALPHA);b.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE);return c}}(this);this.postInit()};n.enable=function(a,b){return a.gl2d||new n(a,b)};n.prototype.getFragmentShaderSource=function(a){return["#ifdef GL_ES\nprecision highp float;\n#endif","#define hasTexture "+(a&1?"1":"0"),"#define hasCrop "+(a&2?"1":"0"),"varying vec4 vColor;\n#if hasTexture\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n#if hasCrop\nuniform vec4 uCropSource;\n#endif\n#endif\nvoid main(void) {\n#if hasTexture\n#if hasCrop\ngl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy);\n#else\ngl_FragColor = texture2D(uSampler, vTextureCoord);\n#endif\n#else\ngl_FragColor = vColor;\n#endif\n}"].join("\n")};
n.prototype.getVertexShaderSource=function(a,b){var c=2/this.canvas.width,d=-2/this.canvas.height;a=a||1;return["#define hasTexture "+(b&1?"1":"0"),"attribute vec4 aVertexPosition;\n#if hasTexture\nvarying vec2 vTextureCoord;\n#endif\nuniform vec4 uColor;","uniform mat3 uTransforms["+a+"];","varying vec4 vColor;","const mat4 pMatrix = mat4("+c+",0,0,0, 0,"+d+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);","mat3 crunchStack(void) {\nmat3 result = uTransforms[0];","for (int i = 1; i < "+a+"; ++i) {","result = uTransforms[i] * result;\n}\nreturn result;\n}\nvoid main(void) {\nvec3 position = crunchStack() * vec3(aVertexPosition.x, aVertexPosition.y, 1.0);\ngl_Position = pMatrix * vec4(position, 1.0);\nvColor = uColor;\n#if hasTexture\nvTextureCoord = aVertexPosition.zw;\n#endif\n}"].join("\n")};
n.prototype.initShaders=function(a,b){var c=this.gl;a=a||1;b=b||0;var d=this.shaderPool[a];d||(d=this.shaderPool[a]=[]);if(d=d[b])return c.useProgram(d),this.shaderProgram=d;var e=this.fs=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fs,this.getFragmentShaderSource(b));c.compileShader(this.fs);if(!c.getShaderParameter(this.fs,c.COMPILE_STATUS))throw"fragment shader error: "+c.getShaderInfoLog(this.fs);var k=this.vs=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vs,this.getVertexShaderSource(a,
b));c.compileShader(this.vs);if(!c.getShaderParameter(this.vs,c.COMPILE_STATUS))throw"vertex shader error: "+c.getShaderInfoLog(this.vs);d=this.shaderProgram=c.createProgram();d.stackDepth=a;c.attachShader(d,e);c.attachShader(d,k);c.linkProgram(d);if(!c.getProgramParameter(d,c.LINK_STATUS))throw"Could not initialise shaders.";c.useProgram(d);d.vertexPositionAttribute=c.getAttribLocation(d,"aVertexPosition");c.enableVertexAttribArray(d.vertexPositionAttribute);d.uColor=c.getUniformLocation(d,"uColor");
d.uSampler=c.getUniformLocation(d,"uSampler");d.uCropSource=c.getUniformLocation(d,"uCropSource");d.uTransforms=[];for(e=0;e<a;++e)d.uTransforms[e]=c.getUniformLocation(d,"uTransforms["+e+"]");return this.shaderPool[a][b]=d};var s,q,r=new Float32Array([0,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0]);n.prototype.initBuffers=function(){var a=this.gl;s=a.createBuffer();a.createBuffer();q=a.createBuffer();a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,r,a.STATIC_DRAW)};n.instances=[];n.prototype.postInit=
function(){n.instances.push(this)};n.prototype.initCanvas2DAPI=function(){function a(b,c,d,f){function e(a){return 1>6*a?g+(h-g)*a*6:1>2*a?h:2>3*a?g+(h-g)*(2/3-a)*6:g}var g,h;b=(b%360+360)%360/360;c=100<c?1:c/100;c=0>c?0:c;d=100<d?1:d/100;d=0>d?0:d;h=.5>=d?d*(c+1):d+c-d*c;g=2*d-h;c=e(b+1/3);d=e(b);b=e(b-1/3);return[c,d,b,f]}function b(c){var d=[],e,f,g,h,k;if(e=D.exec(c)){g=e[1];h=parseFloat(e[8]);if(g&&isNaN(h)||!g&&!isNaN(h))return!1;k=e[3];for(var m=2;8>m;m+=2){c=e[m];f=e[m+1];if(f!==k)return!1;
c=f?100<c?1:c/100:255<c?1:c/255;c=0>c?0:c;d.push(c)}d.push(g?h:1)}else if(e=E.exec(c))g=e[1],h=parseFloat(e[5]),d=a(e[2],e[3],e[4],parseFloat(g&&h?h:1));else if(e=F.exec(c))d=parseInt(e[1],16),d=[((d&16711680)>>16)/255,((d&65280)>>8)/255,(d&255)/255,1];else if(e=z.exec(c))d="#"+[e[1],e[1],e[2],e[2],e[3],e[3]].join(""),d=b(d);else if(c.toLowerCase()in t)d=b(t[c.toLowerCase()]);else if("transparent"===c.toLowerCase())d=[0,0,0,0];else return!1;return d}function d(a){return"rgba("+255*a[0]+", "+255*a[1]+
", "+255*a[2]+", "+parseFloat(a[3])+")"}function e(a){for(var b=h.transform.m_stack,c=0,d=h.transform.c_stack+1;c<d;++c)f.uniformMatrix3fv(a.uTransforms[c],!1,b[d-1-c])}function k(a,b){this.closed=!1;this.verts=[a,b,0,0]}function m(a){this.obj=f.createTexture();this.index=C.push(this);y.push(a);if(a.width>h.maxTextureSize||a.height>h.maxTextureSize){var b=document.createElement("canvas");b.width=a.width>h.maxTextureSize?h.maxTextureSize:a.width;b.height=a.height>h.maxTextureSize?h.maxTextureSize:
a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height);a=b}f.bindTexture(f.TEXTURE_2D,this.obj);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,a);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);c(a.width)&&c(a.height)?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D)):
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR);f.bindTexture(f.TEXTURE_2D,null)}var h=this,f=this.gl,n=document.createElement("canvas");n.width=h.canvas.width;n.height=h.canvas.height;var r=n.getContext("2d"),D=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/,E=/^hsl(a)?\(\s*(-?[\d\.]+)\s*,\s*(-?[\d\.]+)%\s*,\s*(-?[\d\.]+)%\s*,?\s*(-?[\d\.]+)?\s*\)$/,F=/^#([0-9A-Fa-f]{6})$/,z=/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/,t={aliceblue:"#f0f8ff",
antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",
darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",
grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",
lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",
orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",
springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},g={},u=[];g.fillStyle=[0,0,0,1];Object.defineProperty(f,"fillStyle",{get:function(){return d(g.fillStyle)},set:function(a){g.fillStyle=b(a)||g.fillStyle}});g.strokeStyle=[0,0,0,1];Object.defineProperty(f,"strokeStyle",{get:function(){return d(g.strokeStyle)},set:function(a){g.strokeStyle=
b(a)||drawStyle.strokeStyle}});f.$lineWidth=f.lineWidth;g.lineWidth=1;Object.defineProperty(f,"lineWidth",{get:function(){return g.lineWidth},set:function(a){f.$lineWidth(a);g.lineWidth=a}});g.lineCap="butt";Object.defineProperty(f,"lineCap",{get:function(){return g.lineCap},set:function(a){g.lineCap=a}});g.lineJoin="miter";Object.defineProperty(f,"lineJoin",{get:function(){return g.lineJoin},set:function(a){g.lineJoin=a}});g.miterLimit=10;Object.defineProperty(f,"miterLimit",{get:function(){return g.miterLimit},
set:function(a){g.miterLimit=a}});g.shadowOffsetX=0;Object.defineProperty(f,"shadowOffsetX",{get:function(){return g.shadowOffsetX},set:function(a){g.shadowOffsetX=a}});g.shadowOffsetY=0;Object.defineProperty(f,"shadowOffsetY",{get:function(){return g.shadowOffsetY},set:function(a){g.shadowOffsetY=a}});g.shadowBlur=0;Object.defineProperty(f,"shadowBlur",{get:function(){return g.shadowBlur},set:function(a){g.shadowBlur=a}});g.shadowColor="rgba(0, 0, 0, 0.0)";Object.defineProperty(f,"shadowColor",{get:function(){return g.shadowColor},
set:function(a){g.shadowColor=a}});g.font="10px sans-serif";Object.defineProperty(f,"font",{get:function(){return g.font},set:function(a){r.font=a;g.font=a}});g.textAlign="start";Object.defineProperty(f,"textAlign",{get:function(){return g.textAlign},set:function(a){g.textAlign=a}});g.textBaseline="alphabetic";Object.defineProperty(f,"textBaseline",{get:function(){return g.textBaseline},set:function(a){g.textBaseline=a}});g.globalAlpha=1;Object.defineProperty(f,"globalAlpha",{get:function(){return g.globalAlpha},
set:function(a){g.globalAlpha=a}});g.globalCompositeOperation="source-over";Object.defineProperty(f,"globalCompositeOperation",{get:function(){return g.globalCompositeOperation},set:function(a){g.globalCompositeOperation=a}});f.fillText=function(a,b,c){};f.strokeText=function(){};f.measureText=function(){return 1};var w=document.createElement("canvas").getContext("2d");f.save=function(){h.transform.pushMatrix();u.push({fillStyle:[g.fillStyle[0],g.fillStyle[1],g.fillStyle[2],g.fillStyle[3]],strokeStyle:[g.strokeStyle[0],
g.strokeStyle[1],g.strokeStyle[2],g.strokeStyle[3]],globalAlpha:g.globalAlpha,globalCompositeOperation:g.globalCompositeOperation,lineCap:g.lineCap,lineJoin:g.lineJoin,lineWidth:g.lineWidth,miterLimit:g.miterLimit,shadowColor:g.shadowColor,shadowBlur:g.shadowBlur,shadowOffsetX:g.shadowOffsetX,shadowOffsetY:g.shadowOffsetY,textAlign:g.textAlign,font:g.font,textBaseline:g.textBaseline})};f.restore=function(){h.transform.popMatrix();u.length&&(g=u.pop())};f.translate=function(a,b){h.transform.translate(a,
b)};f.rotate=function(a){h.transform.rotate(a)};f.scale=function(a,b){h.transform.scale(a,b)};f.createImageData=function(a,b){return w.createImageData(a,b)};f.getImageData=function(a,b,c,d){var e=w.createImageData(c,d),g=new Uint8Array(c*d*4);f.readPixels(a,b,c,d,f.RGBA,f.UNSIGNED_BYTE,g);a=4*c;b=0;for(c=d/2;b<c;++b)for(var h=0,k=a;h<k;++h){var m=b*a+h,n=(d-b-1)*a+h;e.data[m]=g[n];e.data[n]=g[m]}return e};f.putImageData=function(a,b,c){f.drawImage(a,b,c)};f.transform=function(a,b,c,d,e,f){var g=h.transform.m_stack[h.transform.c_stack];
g[0]*=a;g[1]*=c;g[2]*=e;g[3]*=b;g[4]*=d;g[5]*=f;g[6]=0;g[7]=0};f.setTransform=function(a,b,c,d,e,g){h.transform.setIdentity();f.transform.apply(this,arguments)};f.fillRect=function(a,b,c,d){var k=h.transform,m=h.initShaders(k.c_stack+2,0);f.bindBuffer(f.ARRAY_BUFFER,s);f.vertexAttribPointer(m.vertexPositionAttribute,4,f.FLOAT,!1,0,0);k.pushMatrix();k.translate(a,b);k.scale(c,d);e(m);f.uniform4f(m.uColor,g.fillStyle[0],g.fillStyle[1],g.fillStyle[2],g.fillStyle[3]);f.drawArrays(f.TRIANGLE_FAN,0,4);
k.popMatrix()};f.strokeRect=function(a,b,c,d){var k=h.transform,m=h.initShaders(k.c_stack+2,0);f.bindBuffer(f.ARRAY_BUFFER,s);f.vertexAttribPointer(m.vertexPositionAttribute,4,f.FLOAT,!1,0,0);k.pushMatrix();k.translate(a,b);k.scale(c,d);e(m);f.uniform4f(m.uColor,g.strokeStyle[0],g.strokeStyle[1],g.strokeStyle[2],g.strokeStyle[3]);f.drawArrays(f.LINE_LOOP,0,4);k.popMatrix()};f.clearRect=function(a,b,c,d){};var p=[];f.beginPath=function(){p.length=0};f.closePath=function(){if(p.length){var a=p[p.length-
1],b=a.verts[0],c=a.verts[1];a.closed=!0;a=new k(b,c);p.push(a)}};f.moveTo=function(a,b){p.push(new k(a,b))};f.lineTo=function(a,b){p.length?p[p.length-1].verts.push(a,b,0,0):f.moveTo(a,b)};f.quadraticCurveTo=function(a,b,c,d){};f.bezierCurveTo=function(a,b,c,d,e,f){};f.arcTo=function(){};f.rect=function(a,b,c,d){f.moveTo(a,b);f.lineTo(a+c,b);f.lineTo(a+c,b+d);f.lineTo(a,b+d);f.closePath()};f.arc=function(a,b,c,d,e,f){};f.fill=function(){for(var a=0;a<p.length;a++){var b=a,c=h.transform,d=h.initShaders(c.c_stack+
2,0),b=p[b].verts;f.bindBuffer(f.ARRAY_BUFFER,q);f.bufferData(f.ARRAY_BUFFER,new Float32Array(b),f.STATIC_DRAW);f.vertexAttribPointer(d.vertexPositionAttribute,4,f.FLOAT,!1,0,0);c.pushMatrix();e(d);f.uniform4f(d.uColor,g.fillStyle[0],g.fillStyle[1],g.fillStyle[2],g.fillStyle[3]);f.drawArrays(f.TRIANGLE_FAN,0,b.length/4);c.popMatrix()}};f.stroke=function(){for(var a=0;a<p.length;a++){var b=a,c=h.transform,d=h.initShaders(c.c_stack+2,0),b=p[b],k=b.verts;f.bindBuffer(f.ARRAY_BUFFER,q);f.bufferData(f.ARRAY_BUFFER,
new Float32Array(k),f.STATIC_DRAW);f.vertexAttribPointer(d.vertexPositionAttribute,4,f.FLOAT,!1,0,0);c.pushMatrix();e(d);f.uniform4f(d.uColor,g.strokeStyle[0],g.strokeStyle[1],g.strokeStyle[2],g.strokeStyle[3]);b.closed?f.drawArrays(f.LINE_LOOP,0,k.length/4):f.drawArrays(f.LINE_STRIP,0,k.length/4);c.popMatrix()}};f.clip=function(){};f.isPointInPath=function(){};f.drawFocusRing=function(){};var y=[],C=[];f.drawImage=function(a,b,c,d,g,k,n,q,r){var p=h.transform;p.pushMatrix();var v=1,u=!1;3===arguments.length?
(p.translate(b,c),p.scale(a.width,a.height)):5===arguments.length?(p.translate(b,c),p.scale(d,g)):9===arguments.length&&(p.translate(k,n),p.scale(q,r),v|=2,u=!0);var v=h.initShaders(p.c_stack,v),t;t=y.indexOf(a);t=-1!==t?C[t]:new m(a);u&&f.uniform4f(v.uCropSource,b/a.width,c/a.height,d/a.width,g/a.height);f.bindBuffer(f.ARRAY_BUFFER,s);f.vertexAttribPointer(v.vertexPositionAttribute,4,f.FLOAT,!1,0,0);f.bindTexture(f.TEXTURE_2D,t.obj);f.activeTexture(f.TEXTURE0);f.uniform1i(v.uSampler,0);e(v);f.drawArrays(f.TRIANGLE_FAN,
0,4);p.popMatrix()}}})(Math);FF.Util=function(){};FF.Util.createRender=function(a){var b=new FF.CanvasRender;b.createRender(a);return b};FF.Util.h2r=function(a){a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,c,d,e){return c+c+d+d+e+e});return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null};FF.Util.r2h=function(a,b,c){return"#"+(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1)};
FF.Util.screenSize=function(){var a={width:0,height:0};window.innerWidth?(a.width=window.innerWidth,a.height=window.innerHeight):0!=document.documentElement.clientWidth?(a.width=document.documentElement.clientWidth,a.height=document.documentElement.clientHeight):(a.width=document.body.clientWidth,a.height=document.body.clientHeight);return a};FF.Util.screenWidth=function(){return FF.Util.screenSize().width};FF.Util.screenHeight=function(){return FF.Util.screenSize().height};
FF.Util.getCenterFromItem=function(a,b){return b?FF.Render.getHeight()/2-a.rect().height/2:FF.Render.getWidth()/2-a.rect().width/2};FF.Util.getBrowserInfos=function(){return{name:navigator.appName,version:navigator.appVersion}};FF.Util.getXMLHttpRequest=function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")};
FF.Util.ajax=function(a){var b=a.type||"POST",c=a.async||!0,d=a.url||"",e=a.complete||function(a){},k=FF.Util.getXMLHttpRequest();k.onreadystatechange=function(){4==k.readyState&&e(k.responseText)};k.open(b,d,c);k.send()};FF.Util.collideRects=function(a,b){a.right=a.x+a.width;a.bottom=a.y+a.height;b.right=b.x+b.width;b.bottom=b.y+b.height;return(a.x>=b.x&&a.x<=b.right||b.x>=a.x&&b.x<=a.right)&&(a.y>=b.y&&a.y<=b.bottom||b.y>=a.y&&b.y<=a.bottom)};
FF.Util.collideOneWithOne=function(a,b){return a.rect&&b.rect&&a!==b&&FF.Util.collideRects(a.rect(),b.rect())?!0:!1};FF.Util.collideOneWithMany=function(a,b){var c=[];if(void 0!==b)if(b.foreach)b.foreach(function(b){FF.Util.collideOneWithOne(a,b)&&c.push(b)});else if(b instanceof Array||b.length)for(var d=0;d<b.length;d++)FF.Util.collideOneWithOne(a,b[d])&&c.push(b[d]);else for(d in b)FF.Util.collideOneWithOne(a,b[d])&&c.push(b[d]);return c};
FF.Util.isArray=function(a){return a instanceof Array?!0:!1};FF.Util.isString=function(a){return"string"==typeof a?!0:!1};FF.Util.getDOMDocument=function(a){var b=null;window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a));return b};FF.Util.random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)};
FF.Viewport=function(a){this.y=this.x=0;this.max_x=a.max_x||FF.Render.width;this.max_y=a.max_y||FF.Render.height;this.width=a.width||FF.Render.width;this.height=a.height||FF.Render.height;this.moving=!1};FF.Viewport.prototype.move=function(a,b){this.x+=a||0;this.y+=b||0;this.verifyPosition()};FF.Viewport.prototype.moveTo=function(a,b){this.x=a||this.x;this.y=b||this.y;this.verifyPosition()};
FF.Viewport.prototype.isInside=function(a){return a.x>=this.x&&a.x<=this.x+this.width&&a.y>=this.y&&a.y<=this.y+this.height};FF.Viewport.prototype.isOutside=function(a){return!this.isInside(a)};FF.Viewport.prototype.isPartlyInside=function(a){var b=a.rect();b.right=b.x+b.width;b.bottom=b.y+b.height;return b.right>=this.x&&b.x<=this.x+this.width&&b.bottom>=this.y&&a.y<=this.y+this.height};FF.Viewport.prototype.isLeftOf=function(a){return a.x<this.x};
FF.Viewport.prototype.isRightOf=function(a){return a.x>this.x+this.width};FF.Viewport.prototype.isAbove=function(a){return a.y<this.y};FF.Viewport.prototype.isBelow=function(a){return a.y>this.y+this.height};FF.Viewport.prototype.centerAround=function(a){this.x=Math.floor(a.x-this.width/2);this.y=Math.floor(a.y-this.height/2);this.verifyPosition()};
FF.Viewport.prototype.forceInsideVisibleArea=function(a,b){a.x<this.x+b&&(a.x=this.x+b);a.x>this.x+FF.Render.Context.width-b&&(a.x=this.x+FF.Render.Context.width-b);a.y<this.y+b&&(a.y=this.y+b);a.y>this.y+FF.Render.Context.height-b&&(a.y=this.y+FF.Render.Context.height-b)};FF.Viewport.prototype.forceInside=function(a,b){a.x<b&&(a.x=b);a.x>this.max_x-b&&(a.x=this.max_x-b);a.y<b&&(a.y=b);a.y>this.max_y-b&&(a.y=this.max_y-b)};
FF.Viewport.prototype.apply=function(a){FF.Render.save();FF.Render.translate(-this.x,-this.y);a();FF.Render.restore()};FF.Viewport.prototype.draw=function(a,b,c){var d=this;this.apply(function(){a.draw&&d.drawIfPartlyInside(a,b,c)})};FF.Viewport.prototype.drawIfPartlyInside=function(a,b,c){this.isPartlyInside(a)&&(b?eval("item."+b+'("'+c+'");'):a.draw())};
FF.Viewport.prototype.verifyPosition=function(){var a=0,b=this.max_x-this.width;0>this.x?this.x=0:a++;this.x>b?this.x=b:a++;b=this.max_y-this.height;0>this.y?this.y=0:a++;this.y>b?this.y=b:a++;this.moving=2<a?!0:!1};FF.Viewport.prototype.rect=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}};FF.WebSocketServer=function(a,b){FF.EventManager.call(this);this.session_data=b;this.url=a};
FF.WebSocketServer.prototype.query=function(a,b){this.socket.send(JSON.stringify({fn:a,fn_master:a,ID:this.session_data.ID,SID:this.session_data.SID,content:b}))};FF.WebSocketServer.prototype.onopen=function(a){this.sendAccountingRequest();this.dispatchEvent({type:"start"})};FF.WebSocketServer.prototype.onerror=function(a){};FF.WebSocketServer.prototype.onclose=function(a){console.log(a)};FF.WebSocketServer.prototype.onmessage=function(a){this.dispatchEvent({type:"message",msg:JSON.parse(a.data)})};
FF.WebSocketServer.prototype.sendAccountingRequest=function(){this.query("accounting_start",{sessionData:this.session_data})};FF.WebSocketServer.prototype.start=function(){var a=this;this.socket=new WebSocket(this.url);this.socket.onopen=function(b){a.onopen(b)};this.socket.onmessage=function(b){a.onmessage(b)};this.socket.onerror=function(b){a.onerror(b)};this.socket.onclose=function(b){a.onclose(b)}};
